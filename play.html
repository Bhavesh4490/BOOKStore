<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<title>BOOKStore Premium Player</title>
<script src="https://unpkg.com/@phosphor-icons/web"></script>

<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600&display=swap" rel="stylesheet">
<script src="https://cdn.jsdelivr.net/npm/hls.js@latest"></script>
<link rel="icon" type="image/png" href="book.png">
<style>
    :root {
  /* Bridge theme.css â†’ player.css */
  --bg-dark: var(--bg-color, #050505);
  --glass-bg: rgba(20, 28, 45, 0.85);
  --glass-border: rgba(255, 255, 255, 0.08);

  --accent: var(--accent-color, #379dfd);
  --accent-glow: rgba(55, 157, 253, 0.6);

  --text-primary: var(--text-color, #ffffff);
  --text-secondary: rgba(203, 213, 225, 0.85);

  --transition: all 0.25s ease;
}

    /* =========================================
       1. VARIABLES & RESET
       ========================================= */
   

    * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
    
    body {
background:
    radial-gradient(circle at top,
      rgba(55, 157, 253, 0.08),
      transparent 60%),
    linear-gradient(180deg,
      #020617,
      var(--bg-dark));
        margin: 0;
        padding: 0;
        color: var(--text-primary);
        font-family: 'Inter', sans-serif;
        overflow: hidden;
    }

    /* =========================================
       2. PLAYER CONTAINER
       ========================================= */
    .player-container {
        position: relative;
        width: 100vw;
        height: 100vh;
       background: var(--bg-dark);
        display: flex;
        justify-content: center;
        align-items: center;
        overflow: hidden;
    }

    video {
        width: 100%;
        height: 100%;
        object-fit: contain;
    }

    /* =========================================
       3. FLOATING CONTROLS
       ========================================= */
    .controls-and-seek-container {
        position: absolute;
        bottom: 30px;
        left: 50%;
        transform: translateX(-50%) translateY(0);
        width: 90%;
        max-width: 1000px;
        display: flex;
        flex-direction: column;
        gap: 15px;
        z-index: 100;
        transition: opacity 0.4s ease, transform 0.4s ease;
        opacity: 1;
        padding-bottom: 10px; /* Safe area */
    }

    .controls-and-seek-container.hidden {
        opacity: 0;
        transform: translateX(-50%) translateY(20px);
        pointer-events: none;
    }

    .controls {
        width: 100%;
         background:
    linear-gradient(
      180deg,
      rgba(255,255,255,0.06),
      rgba(255,255,255,0.02)
    ),
    var(--glass-bg);
        backdrop-filter: blur(16px);
        -webkit-backdrop-filter: blur(16px);
         border: 1px solid var(--glass-border);
        padding: 12px 24px;
        border-radius: 16px;
        display: flex;
        justify-content: space-between;
        align-items: center;
        box-shadow: 0 8px 32px rgba(0, 0, 0, 0.4);
    }

    .controls-left, .controls-right {
        display: flex;
        align-items: center;
        gap: 16px;
    }

    /* =========================================
       4. ICONS & BUTTONS
       ========================================= */
    .ctrl-icon {
    font-size: 21px;              /* BASE SIZE */
    line-height: 1;
    display: flex;                /* ðŸ”‘ */
    align-items: center;          /* ðŸ”‘ */
    justify-content: center;      /* ðŸ”‘ */
    width: 32px;                  /* click area */
    height: 32px;
    cursor: pointer;
    opacity: 0.85;
    transition: var(--transition);
    filter: drop-shadow(0 2px 2px rgba(0,0,0,0.3));
}


    .ctrl-icon:hover {
        opacity: 1;
        transform: scale(1.15);
        filter: drop-shadow(0 0 8px var(--accent-glow));
        color: var(--accent);
    }

    .ctrl-icon:active { transform: scale(0.95); }
    #playPauseBtn {
    font-size: 21px;   /* bigger icon */
}


    #timeDisplay {
        font-family: 'Inter', monospace;
        font-size: 13px;
        font-weight: 500;
        color: var(--text-secondary);
        min-width: 100px;
        text-align: center;
        cursor: pointer;
        transition: color 0.2s;
    }
    #timeDisplay:hover { color: #fff; }

    /* =========================================
       5. SEEK BAR & VOLUME
       ========================================= */
    .seek-wrapper {
        width: 100%;
        height: 8px; 
        display: flex;
        align-items: center;
        cursor: pointer;
        position: relative;
    }

    .seek-bar {
        -webkit-appearance: none;
        appearance: none;
        width: 100%;
        height: 4px;
        background: rgba(255, 255, 255, 0.2);
        border-radius: 4px;
        outline: none;
        cursor: pointer;
        transition: height 0.1s ease;
        position: relative;
        z-index: 2;
         box-shadow: 0 0 12px rgba(0,0,0,0.6);
    }
    .seek-wrapper:hover .seek-bar { height: 6px; }

    .seek-bar::-webkit-slider-runnable-track {
        height: 100%;
        border-radius: 4px;
        background: linear-gradient(to right, var(--accent) var(--seek-pos, 0%), transparent var(--seek-pos, 0%));
    }

    .seek-bar::-webkit-slider-thumb {
        -webkit-appearance: none;
        width: 14px;
        height: 14px;
        background: #fff;
        border-radius: 50%;
        transform: scale(0);
        transition: transform 0.1s;
        box-shadow: 0 0 10px rgba(0,0,0,0.5);
        margin-top: -4px;
    }
    .seek-wrapper:hover .seek-bar::-webkit-slider-thumb { transform: scale(1); }

    .bottom-progress {
        position: absolute;
        bottom: 0;
        left: 0;
        height: 3px;
        background: var(--accent);
        width: 0%;
        z-index: 200;
        transition: width 0.1s linear;
        box-shadow: 0 -1px 10px var(--accent-glow);
    }

    .volume-box {
        display: flex;
        align-items: center;
        position: relative;
        height: 30px;
    }
    #volumeSlider {
        width: 0;
        height: 4px;
        -webkit-appearance: none;
        background: rgba(255,255,255,0.2);
        border-radius: 4px;
        margin-left: 0;
        opacity: 0;
        transition: var(--transition);
        overflow: hidden;
    }
    .volume-box:hover #volumeSlider { width: 70px; opacity: 1; margin-left: 10px; }
    #volumeSlider::-webkit-slider-thumb {
        -webkit-appearance: none; height: 12px; width: 12px;
        border-radius: 50%; background: #fff; margin-top: -4px;
    }
    #volumeSlider::-webkit-slider-runnable-track {
        height: 4px;
        background: linear-gradient(to right, #fff var(--vol-pos, 100%), rgba(255,255,255,0.2) var(--vol-pos, 100%));
    }

    /* =========================================
       6. SETTINGS MENU
       ========================================= */
    .settings-menu {
        position: absolute;
        bottom: 70px; 
        right: 0;
        width: 220px;
        background: rgba(18, 24, 38, 0.95);
        backdrop-filter: blur(20px);
        border: 1px solid var(--glass-border);
        border-radius: 12px;
        padding: 8px;
        display: none;
        flex-direction: column;
        gap: 4px;
        box-shadow: 0 10px 40px rgba(0,0,0,0.6);
        animation: slideUp 0.2s cubic-bezier(0.16, 1, 0.3, 1);
        z-index: 200;
    }
    @keyframes slideUp { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }

    .main-setting-btn {
        display: flex; justify-content: space-between; align-items: center;
        padding: 12px 16px; color: var(--text-secondary);
        font-size: 14px; font-weight: 500; cursor: pointer;
        border-radius: 8px; transition: background 0.2s;
    }
    .main-setting-btn:hover { background: rgba(255,255,255,0.08); color: #fff; }
    .main-setting-btn b { color: #fff; }
    .main-setting-btn::after { content: attr(data-current); font-size: 12px; color: var(--accent); font-weight: 600; }

    .drop-box { display: none; background: rgba(0,0,0,0.2); border-radius: 8px; margin-top: 4px; }
    .option { padding: 10px 16px; font-size: 13px; color: #ccc; cursor: pointer; display: flex; align-items: center; }
    .option:hover { background: rgba(255,255,255,0.05); color: #fff; }
    .option.active { color: var(--accent); font-weight: 600; }
    .option.active::before { content: 'â€¢'; margin-right: 8px; font-size: 18px; line-height: 0; }
    .divider { height: 1px; background: rgba(255,255,255,0.1); margin: 4px 0; }

    /* =========================================
       7. POPUPS (Link, History, Library)
       ========================================= */
    .glass-overlay {
        position: fixed; inset: 0;
        background: rgba(0, 0, 0, 0.7);
        backdrop-filter: blur(8px);
        display: flex; justify-content: center; align-items: center;
        z-index: 9999; opacity: 0; pointer-events: none;
        transition: opacity 0.3s ease;
    }
    .glass-overlay.show { opacity: 1; pointer-events: auto; }

    /* Right Side Slide-in (History & Library) */
    .glass-overlay.right { justify-content: flex-end; }
    .glass-overlay.right .glass-popup {
        height: 100vh; width: 400px; max-width: 85vw;
        border-radius: 0; border-left: 1px solid var(--glass-border);
        transform: translateX(100%);
        transition: transform 0.3s cubic-bezier(0.16, 1, 0.3, 1);
    }
    .glass-overlay.right.show .glass-popup { transform: translateX(0); }

    /* Center Modal */
    .glass-popup {
        background: #111827; width: 420px; max-width: 90%;
        padding: 30px; border-radius: 20px;
        border: 1px solid var(--glass-border);
        box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.8);
        transform: scale(0.95); transition: transform 0.3s ease;
        display: flex; flex-direction: column;
    }
    .glass-overlay.show .glass-popup { transform: scale(1); }

    .glass-popup h2 { margin: 0 0 8px; font-size: 20px; font-weight: 600; color: #fff; }
    .glass-popup p { color: var(--text-secondary); font-size: 13px; margin-bottom: 20px; line-height: 1.5; }

    /* Inputs */
    .glass-popup input {
        width: 100%; background: rgba(255,255,255,0.05);
        border: 1px solid var(--glass-border);
        padding: 14px; border-radius: 12px;
        color: #fff; font-size: 14px; outline: none;
        transition: border 0.2s; margin-bottom: 10px;
    }
    .glass-popup input:focus { border-color: var(--accent); background: rgba(255,255,255,0.08); }
    .glass-popup label {
        font-size: 12px; color: var(--accent); font-weight: 600;
        margin-bottom: 6px; display: block; margin-top: 5px;
    }

    .or-divider {
        display: flex; align-items: center; color: var(--text-secondary);
        font-size: 11px; margin: 15px 0; font-weight: 600; text-transform: uppercase;
        letter-spacing: 1px;
    }
    .or-divider::before, .or-divider::after {
        content: ''; flex: 1; height: 1px; background: rgba(255,255,255,0.1);
    }
    .or-divider::before { margin-right: 10px; }
    .or-divider::after { margin-left: 10px; }

    /* Buttons */
    .glass-popup button {
        width: 100%; padding: 14px; background: var(--accent);
        color: #fff; border: none; border-radius: 12px;
        font-weight: 600; font-size: 14px; cursor: pointer;
        transition: var(--transition);
        box-shadow: 0 4px 15px rgba(55, 157, 253, 0.3); margin-top: 10px;
    }
    .glass-popup button:hover { background: #278ceb; transform: translateY(-2px); }

    .error-text { color: #ff4d4d; font-size: 12px; margin-top: 8px; min-height: 18px; text-align: center; }

    /* History & Library Lists */
    #historyList, #libraryList {
        margin-top: 10px; flex: 1; overflow-y: auto; padding-right: 5px;
    }
    #historyList::-webkit-scrollbar, #libraryList::-webkit-scrollbar { width: 4px; }
    #historyList::-webkit-scrollbar-thumb, #libraryList::-webkit-scrollbar-thumb { background: #333; border-radius: 2px; }

    /* History Item */
    .history-item {
        background: rgba(255,255,255,0.03); border-radius: 12px;
        padding: 12px; margin-bottom: 8px; cursor: pointer;
        transition: var(--transition); border: 1px solid transparent;
    }
    .history-item:hover { background: rgba(255,255,255,0.08); border-color: rgba(255,255,255,0.1); }
    .history-top { display: flex; justify-content: space-between; margin-bottom: 4px; }
    .history-title { font-weight: 500; font-size: 14px; color: #fff; }
    .history-item small { color: #888; font-size: 11px; }

    /* Premium Library Cards */
    .library-card {
        background: linear-gradient(145deg, rgba(255,255,255,0.05), rgba(255,255,255,0.02));
        border: 1px solid var(--glass-border);
        border-radius: 16px;
        padding: 16px; margin-bottom: 12px;
        cursor: pointer; position: relative; overflow: hidden;
        transition: all 0.3s cubic-bezier(0.25, 0.8, 0.25, 1);
        display: flex; align-items: center; gap: 15px;
    }
    .library-card:hover {
        transform: translateY(-4px);
        background: linear-gradient(145deg, rgba(255,255,255,0.1), rgba(255,255,255,0.04));
        border-color: rgba(55, 157, 253, 0.3);
        box-shadow: 0 10px 30px rgba(0,0,0,0.5);
    }
    .play-icon-bg {
        width: 40px; height: 40px; border-radius: 50%;
        background: rgba(55, 157, 253, 0.15);
        display: flex; align-items: center; justify-content: center;
        flex-shrink: 0; color: var(--accent); transition: 0.3s;
    }
    .library-card:hover .play-icon-bg { background: var(--accent); color: #fff; transform: scale(1.1); }
    .card-info { flex: 1; }
    .card-title { font-weight: 600; font-size: 15px; color: #fff; margin-bottom: 4px; line-height: 1.4; }
    .card-meta { font-size: 11px; color: var(--text-secondary); display: flex; gap: 10px; }
    .card-tag { background: rgba(255,255,255,0.1); padding: 2px 8px; border-radius: 4px; }

    @media (max-width: 600px) {
        .controls { padding: 10px 15px; }
        .controls-and-seek-container { width: 95%; bottom: 15px; }
        #volumeBox { display: none; }
        .settings-menu { bottom: 60px; }
        .glass-popup { width: 95%; padding: 25px; }
    }
    /* ===== History Remove Button ===== */
.history-item {
    position: relative;
    overflow: hidden;
}

.history-remove {
    position: absolute;
    right: 10px;
    top: 50%;
    transform: translateY(-50%);
    width: 18px;
    height: 18px;
    opacity: 0;
    cursor: pointer;
    transition: var(--transition);
    filter: drop-shadow(0 0 6px rgba(0,0,0,0.4));
}

/* Hover reveal (desktop) */
.history-item:hover .history-remove {
    opacity: 0.85;
}

/* Always visible on mobile */
@media (max-width: 768px) {
    .history-remove {
        opacity: 0.9;
    }
}

.history-remove:hover {
    opacity: 1;
    transform: translateY(-50%) scale(1.15);
    filter: drop-shadow(0 0 10px var(--accent-glow));
}

/* Fade-out removal animation */
.history-item.removing {
    opacity: 0;
    transform: translateX(10px);
    transition: opacity 0.25s ease, transform 0.25s ease;
}
.history-remove {
  font-size: 18px;
  color: #fff;
}

</style>

<link rel="stylesheet" href="theme.css">
<script src="theme.js"></script>
</head>
<body>

<div class="player-container" id="playerContainer">
    
    <video id="video" playsinline></video>
    <div class="bottom-progress" id="bottomProgress"></div>

    <div class="controls-and-seek-container" id="controlsContainer">
        <div class="seek-wrapper">
            <input type="range" id="seekBar" value="0" min="0" max="100" step="0.1" class="seek-bar">
        </div>

        <div class="controls" id="controls">
            <div class="controls-left">
                <i class="ph ph-skip-back ctrl-icon" id="back5" title="-5s"></i>
<i class="ph ph-play ctrl-icon" id="playPauseBtn" title="Play/Pause"></i>
<i class="ph ph-skip-forward ctrl-icon" id="forward5" title="+5s"></i>

                <div class="volume-box" id="volumeBox">
                    <i class="ph ph-speaker-high ctrl-icon" id="volumeBtn" title="Mute"></i>

                    <input type="range" id="volumeSlider" min="0" max="1" step="0.05" value="1">
                </div>
                <span id="timeDisplay">00:00 / 00:00</span>
            </div>

            <div class="controls-right">
                
                <i class="ph ph-clock-counter-clockwise ctrl-icon" id="historyBtn" title="History"></i>
<i class="ph ph-gear ctrl-icon" id="settingsBtn" title="Settings"></i>
                <i class="ph ph-arrows-out ctrl-icon" id="fullscreenBtn" title="Full Screen"></i>
                <i class="ph ph-picture-in-picture ctrl-icon" id="pipBtn" title="Mini Player"></i>

                <div class="settings-menu" id="settingsMenu">
                    <div class="main-setting-btn" data-open="speedBox" id="speedLabel" data-current="Normal"><b>Speed</b></div>
                    <div class="setting-section drop-box" id="speedBox">
                        <div class="option" data-speed="0.25">0.25x</div>
                        <div class="option" data-speed="0.5">0.5x</div>
                        <div class="option active" data-speed="1">Normal</div>
                        <div class="option" data-speed="1.25">1.25x</div>
                        <div class="option" data-speed="1.5">1.5x</div>
                        <div class="option" data-speed="2">2x</div>
                    </div>
                    <div class="divider"></div>
                    <div class="main-setting-btn" data-open="qualityBox" id="qualityLabel" data-current="Auto"><b>Quality</b></div>
                    <div class="setting-section drop-box" id="qualityBox">
                        <div class="option active" data-quality="auto">Auto</div>
                        <div class="option" data-quality="720">720p</div>
                        <div class="option" data-quality="480">480p</div>
                        <div class="option" data-quality="360">360p</div>
                        <div class="option" data-quality="240">240p</div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<div class="glass-overlay" id="linkOverlay">
  <div class="glass-popup">
    <h2>BookStore Player</h2>
    <p>Enter a direct link or a subject directory code to start learning.</p>
    <label>DIRECT VIDEO URL</label>
    <input type="text" id="videoLinkInput" placeholder="https://example.com/video.m3u8">
    <div class="or-divider">OR</div>
    <label>DIRECTORY CODE</label>
    <input type="text" id="directoryCodeInput" placeholder="Type a directory code">
    <div class="error-text" id="linkError"></div>
    <button id="playLinkBtn">Start Learning</button>
  </div>
</div>

<div class="glass-overlay right" id="libraryOverlay">
  <div class="glass-popup">
    <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:15px; border-bottom:1px solid rgba(255,255,255,0.1); padding-bottom:15px;">
        <div id="libraryTitle">
            <h2 style="margin:0; font-size:18px;">Subject Library</h2>
            <small style="color:var(--accent);">Select a chapter to watch</small>
        </div>
        <span style="cursor:pointer; font-size:24px; padding:5px;" onclick="closePopup(libraryOverlay)">Ã—</span>
    </div>
    <div id="libraryList"></div>
  </div>
</div>

<div class="glass-overlay right" id="historyOverlay">
  <div class="glass-popup">
    <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:15px; padding-bottom:10px; border-bottom:1px solid rgba(255,255,255,0.1);">
        <h2>History</h2>
        <span style="cursor:pointer; font-size:24px;" onclick="closePopup(historyOverlay)">Ã—</span>
    </div>
    <div id="historyList"></div>
  </div>
</div>

<script>
// ==========================================
// 1. GLOBAL DATA & STATE
// ==========================================
const DIRECTORY_DATA = {
    "Dhurandhar": [
        { title: "Dhurandhar(2025)", url: "https://cdn4504.seyki394bis.com/stream2/i-cdn-0/9bb3767e03ea2bd8f2e6473c7f36d36d/MJTMsp1RshGTygnMNRUR2N2MSlnWXZEdMNDZzQWe5MDZzMmdZJTO1R2RWVHZDljekhkSsl1VwYnWtx2cihVT21UbGtWTXV1dadlVo9ERs1WTqJ1aOJTVx8ERjBjWqJEaZRlRoplaFRjWqNWP:1766245124:152.58.115.245:71c08778a62d7d6ba4c7e6961941de02e71e360bfe1a6a589c8163a1552c04a2/1080/index.m3u8", tag: "Action/Adventure" },
    ]
};

const video = document.getElementById("video");
const playerContainer = document.getElementById("playerContainer");
const controlsContainer = document.getElementById("controlsContainer");

// Controls
const playBtn = document.getElementById("playPauseBtn");
const back5Btn = document.getElementById("back5");
const forward5Btn = document.getElementById("forward5");
const timeDisplay = document.getElementById("timeDisplay");
const seekBar = document.getElementById("seekBar");
const bottomProgress = document.getElementById("bottomProgress");
const volumeSlider = document.getElementById("volumeSlider");
const volumeBtn = document.getElementById("volumeBtn");
const fullscreenBtn = document.getElementById("fullscreenBtn");
const settingsBtn = document.getElementById("settingsBtn");
const settingsMenu = document.getElementById("settingsMenu");


// State
let isDragging = false;
let currentVideoURL = "";
let currentSpeed = 1;
let activityTimer;
let showRemaining = false;


// ==========================================
// 2. VIDEO LOGIC (Playback, HLS, Speed)
// ==========================================
function loadVideo(url) {
    if (Hls.isSupported()) {
        if(window.hls) window.hls.destroy();
        const hls = new Hls();
        hls.loadSource(url);
        hls.attachMedia(video);
        window.hls = hls;
        hls.on(Hls.Events.MANIFEST_PARSED, () => {
             // Reset UI on new video load
             resetSpeedUI();
        });
    } else {
        video.src = url;
    }
}

function togglePlay() {
  if (video.paused) {
    video.play();
    playBtn.classList.replace("ph-play", "ph-pause");
  } else {
    video.pause();
    playBtn.classList.replace("ph-pause", "ph-play");
  }
}


function seek(delta) {
    if(!video.duration) return;
    const newTime = Math.min(Math.max(video.currentTime + delta, 0), video.duration);
    video.currentTime = newTime;
    resetActivity();
}


// Ensure speed persists
video.addEventListener('ratechange', () => {
    // Sync UI if changed externally, otherwise enforce currentSpeed
});
video.addEventListener('play', () => {
    video.playbackRate = currentSpeed;
});

// ==========================================
// 3. UI CONTROLS IMPLEMENTATION
// ==========================================

// --- Play/Pause ---
playBtn.addEventListener("click", (e) => { e.stopPropagation(); togglePlay(); });
video.addEventListener("click", (e) => { e.stopPropagation(); togglePlay(); });
video.addEventListener("play", () => {
  playBtn.classList.replace("ph-play", "ph-pause"); resetActivity(); });
video.addEventListener("pause", () => {
  playBtn.classList.replace("ph-pause", "ph-play"); resetActivity(); });

// --- Seek Buttons ---
back5Btn.addEventListener("click", (e) => { e.stopPropagation(); seek(-5); });
forward5Btn.addEventListener("click", (e) => { e.stopPropagation(); seek(5); });

// --- Seek Bar Logic (Scrubbing) ---
video.addEventListener("timeupdate", () => {
    if(!isDragging && video.duration) {
        seekBar.value = video.currentTime;
        const pct = (video.currentTime / video.duration) * 100;
        seekBar.style.setProperty("--seek-pos", pct + "%");
        bottomProgress.style.width = pct + "%";
        const watched = formatTime(video.currentTime);
const total = formatTime(video.duration);
const remaining = formatTime(video.duration - video.currentTime);

timeDisplay.textContent = showRemaining
    ? `-${remaining} / ${total}`
    : `${watched} / ${total}`;
    }
});
timeDisplay.addEventListener("click", (e) => {
    e.stopPropagation();
    showRemaining = !showRemaining;
});

video.addEventListener("loadedmetadata", () => {
    seekBar.max = video.duration;
    timeDisplay.textContent = `00:00 / ${formatTime(video.duration)}`;
});

seekBar.addEventListener("mousedown", () => { isDragging = true; });
seekBar.addEventListener("touchstart", () => { isDragging = true; }, {passive: true});

seekBar.addEventListener("input", () => {
    // Update visuals while dragging
    const val = parseFloat(seekBar.value);
    const pct = (val / (video.duration || 1)) * 100;
    seekBar.style.setProperty("--seek-pos", pct + "%");
    bottomProgress.style.width = pct + "%";
    timeDisplay.textContent = `${formatTime(val)} / ${formatTime(video.duration)}`;
    // Optional: Live seek
    video.currentTime = val;
});

const endDrag = () => {
    if(isDragging) {
        video.currentTime = parseFloat(seekBar.value);
        isDragging = false;
    }
};
seekBar.addEventListener("mouseup", endDrag);
seekBar.addEventListener("touchend", endDrag);

// --- Volume Logic ---
function updateVolumeUI(vol) {
    video.volume = Math.max(0, Math.min(1, vol));
    video.muted = (video.volume === 0);
    volumeSlider.value = video.volume;
    
    // Update Slider Gradient
    const pct = video.volume * 100;
    volumeSlider.style.setProperty("--vol-pos", pct + "%");
    
    // Icon
    volumeBtn.className =
    "ph ctrl-icon " + (video.muted ? "ph-speaker-x" : "ph-speaker-high");
}

volumeSlider.addEventListener("input", (e) => {
    updateVolumeUI(e.target.value);
});

volumeBtn.addEventListener("click", (e) => {
    e.stopPropagation();
    if(video.muted || video.volume === 0) {
        video.muted = false;
        updateVolumeUI(1); // Unmute to max
    } else {
        updateVolumeUI(0);
    }
});

// --- Settings Menu ---
settingsBtn.addEventListener("click", (e) => {
    e.stopPropagation();
    settingsMenu.style.display = (settingsMenu.style.display === "flex") ? "none" : "flex";
});

// Settings Tabs
document.querySelectorAll(".main-setting-btn").forEach(btn => {
    btn.addEventListener("click", (e) => {
        e.stopPropagation();
        const targetId = btn.dataset.open;
        const targetBox = document.getElementById(targetId);
        // Hide all boxes first
        document.querySelectorAll(".drop-box").forEach(b => b.style.display = "none");
        // Toggle target
        targetBox.style.display = "block";
    });
});

// Speed Selection
document.querySelectorAll("[data-speed]").forEach(opt => {
    opt.addEventListener("click", (e) => {
        e.stopPropagation();
        const spd = parseFloat(opt.dataset.speed);
        currentSpeed = spd;
        video.playbackRate = spd;
        
        // Update UI
        document.querySelectorAll("[data-speed]").forEach(o => o.classList.remove("active"));
        opt.classList.add("active");
        document.getElementById("speedLabel").dataset.current = opt.innerText;
        settingsMenu.style.display = "none";
    });
});

function resetSpeedUI() {
    currentSpeed = 1;
    video.playbackRate = 1;
    document.querySelectorAll("[data-speed]").forEach(o => o.classList.remove("active"));
    document.querySelector("[data-speed='1']").classList.add("active");
    document.getElementById("speedLabel").dataset.current = "Normal";
}

// Quality Selection (HLS)
document.querySelectorAll("[data-quality]").forEach(opt => {
    opt.addEventListener("click", (e) => {
        e.stopPropagation();
        if(!window.hls) return;

        const qual = opt.dataset.quality;
        
        // UI Update
        document.querySelectorAll("[data-quality]").forEach(o => o.classList.remove("active"));
        opt.classList.add("active");
        document.getElementById("qualityLabel").dataset.current = opt.innerText;

        // Logic
        if(qual === "auto") {
            window.hls.currentLevel = -1;
        } else {
            const targetHeight = parseInt(qual);
            // Find closest level
            let closestLevel = -1;
            let minDiff = Infinity;
            window.hls.levels.forEach((lvl, idx) => {
                const diff = Math.abs(lvl.height - targetHeight);
                if(diff < minDiff) {
                    minDiff = diff;
                    closestLevel = idx;
                }
            });
            if(closestLevel !== -1) window.hls.currentLevel = closestLevel;
        }
        settingsMenu.style.display = "none";
    });
});

// --- Fullscreen ---
fullscreenBtn.addEventListener("click", (e) => {
    e.stopPropagation();
    if(!document.fullscreenElement) {
        if(playerContainer.requestFullscreen) playerContainer.requestFullscreen();
        else if(playerContainer.webkitRequestFullscreen) playerContainer.webkitRequestFullscreen();
    } else {
        if(document.exitFullscreen) document.exitFullscreen();
    }
});
// --- Double Click Fullscreen ---
let lastTap = 0;

video.addEventListener("dblclick", (e) => {
    e.preventDefault();
    toggleFullscreen();
});

// Mobile double-tap support
video.addEventListener("touchend", () => {
    const now = Date.now();
    if (now - lastTap < 300) {
        toggleFullscreen();
    }
    lastTap = now;
});

function toggleFullscreen() {
    if (!document.fullscreenElement && !document.webkitFullscreenElement) {
        if (playerContainer.requestFullscreen) {
            playerContainer.requestFullscreen();
        } else if (playerContainer.webkitRequestFullscreen) {
            playerContainer.webkitRequestFullscreen();
        }
    } else {
        if (document.exitFullscreen) {
            document.exitFullscreen();
        } else if (document.webkitExitFullscreen) {
            document.webkitExitFullscreen();
        }
    }
}

// --- Keyboard Shortcuts ---
document.addEventListener("keydown", (e) => {
    // Ignore inputs
    if(["INPUT", "TEXTAREA"].includes(document.activeElement.tagName)) return;

    switch(e.key) {
        case " ":
        case "k":
        case "K":
            e.preventDefault();
            togglePlay();
            break;
        case "ArrowRight":
            e.preventDefault();
            seek(5);
            break;
        case "ArrowLeft":
            e.preventDefault();
            seek(-5);
            break;
        case "ArrowUp":
            e.preventDefault();
            updateVolumeUI(video.volume + 0.1);
            break;
        case "ArrowDown":
            e.preventDefault();
            updateVolumeUI(video.volume - 0.1);
            break;
        case "f":
        case "F":
            e.preventDefault();
            fullscreenBtn.click();
            break;
        case "m":
        case "M":
            e.preventDefault();
            volumeBtn.click();
            break;
    }
    resetActivity();
});

// ==========================================
// 4. ACTIVITY & OVERLAYS
// ==========================================
function resetActivity() {
    controlsContainer.classList.remove("hidden");
    document.body.style.cursor = "default";
    clearTimeout(activityTimer);
    if(!video.paused) {
        activityTimer = setTimeout(() => {
            controlsContainer.classList.add("hidden");
            document.body.style.cursor = "none";
            settingsMenu.style.display = "none"; // Hide settings on idle
        }, 3000);
    }
}

document.addEventListener("mousemove", resetActivity);
document.addEventListener("click", resetActivity);
// Prevent menu closing when clicking inside controls
controlsContainer.addEventListener("click", (e) => { e.stopPropagation(); resetActivity(); });
document.addEventListener("click", () => { settingsMenu.style.display = "none"; });

// ==========================================
// 5. HELPER UTILS
// ==========================================
function formatTime(t) {
    if(!t || isNaN(t)) return "00:00";
    t = Math.floor(t);
    const h = Math.floor(t/3600);
    const m = Math.floor((t%3600)/60);
    const s = t%60;
    const mm = m.toString().padStart(2, "0");
    const ss = s.toString().padStart(2, "0");
    return h > 0 ? `${h}:${mm}:${ss}` : `${mm}:${ss}`;
}

// ==========================================
// 6. POPUP & DIRECTORY LOGIC
// ==========================================
const linkOverlay = document.getElementById("linkOverlay");
const libraryOverlay = document.getElementById("libraryOverlay");
const historyOverlay = document.getElementById("historyOverlay");
const linkInput = document.getElementById("videoLinkInput");
const dirInput = document.getElementById("directoryCodeInput");
const linkError = document.getElementById("linkError");
const libraryList = document.getElementById("libraryList");
const historyList = document.getElementById("historyList");

function openPopup(el) { el.classList.add("show"); }
function closePopup(el) { el.classList.remove("show"); }

window.addEventListener("load", () => {
    const params = new URLSearchParams(window.location.search);
    const qVideo = params.get("video");
    if(qVideo) {
        loadAndTrack(decodeURIComponent(qVideo));
    } else {
        openPopup(linkOverlay);
    }
});

// Click outside to close
[linkOverlay, libraryOverlay, historyOverlay].forEach(el => {
    el.addEventListener("click", (e) => { if(e.target === el) closePopup(el); });
});

document.getElementById("playLinkBtn").onclick = () => {
    const directLink = linkInput.value.trim();
    const dirCode = dirInput.value.trim();

    if (dirCode.length > 0) {
        if (DIRECTORY_DATA[dirCode]) {
            linkError.textContent = "";
            renderLibrary(dirCode, DIRECTORY_DATA[dirCode]);
            closePopup(linkOverlay);
            openPopup(libraryOverlay);
        } else {
            linkError.textContent = "Invalid Directory Code";
        }
        return;
    }

    if (directLink.length > 0) {
        if (isValidVideo(directLink)) {
            linkError.textContent = "";
            loadAndTrack(directLink);
            closePopup(linkOverlay);
        } else {
            linkError.textContent = "Invalid Video URL";
        }
        return;
    }
    linkError.textContent = "Please enter input";
};

function isValidVideo(url) { return /\.(mp4|m3u8)(\?.*)?$/i.test(url); }

function renderLibrary(codeName, videos) {
    document.querySelector("#libraryTitle small").textContent = codeName;
    libraryList.innerHTML = "";
    videos.forEach(vid => {
        const card = document.createElement("div");
        card.className = "library-card";
        card.innerHTML = `
            <div class="play-icon-bg">
  <i class="ph ph-play"></i>
</div>
            <div class="card-info">
                <div class="card-title">${vid.title}</div>
                <div class="card-meta"><span class="card-tag">${vid.tag||'Chapter'}</span></div>
            </div>`;
        card.onclick = () => {
            loadAndTrack(vid.url, vid.title);
            closePopup(libraryOverlay);
        };
        libraryList.appendChild(card);
    });
}

// History
function getHistory() { return JSON.parse(localStorage.getItem("watchHistory") || "[]"); }
function saveHistory(data) { localStorage.setItem("watchHistory", JSON.stringify(data)); }

function loadAndTrack(url, manualTitle = null) {
    if(currentVideoURL && currentVideoURL !== url) saveProgress(true);
    currentVideoURL = url;
    
    let history = getHistory();
    history = history.filter(h => h.url !== url);
    history.unshift({
        url: url,
        title: manualTitle || url.split("/").pop(),
        time: 0,
        date: new Date().toLocaleString()
    });
    saveHistory(history.slice(0, 50));
    loadVideo(url);
    video.currentTime = 0;
    video.play().catch(()=>{});
}

function saveProgress(force = false) {
    if (!currentVideoURL) return;
    if (!force && video.currentTime < 5) return;
    let history = getHistory();
    const idx = history.findIndex(h => h.url === currentVideoURL);
    if(idx !== -1) {
        history[idx].time = video.currentTime;
        history[idx].date = new Date().toLocaleString();
        saveHistory(history);
    }
}
video.addEventListener("pause", () => saveProgress());
window.addEventListener("beforeunload", () => saveProgress());

document.getElementById("historyBtn").onclick = () => {
    renderHistory();
    openPopup(historyOverlay);
};
function removeHistoryItem(url, el) {
    el.classList.add("removing");

    setTimeout(() => {
        let history = getHistory().filter(h => h.url !== url);
        saveHistory(history);

        el.remove();

        if (history.length === 0) {
            historyList.innerHTML =
                "<p style='text-align:center;opacity:0.5;margin-top:20px'>No history</p>";
        }
    }, 250);
}

function renderHistory() {
    historyList.innerHTML = "";
    const history = getHistory();

    if (history.length === 0) {
        historyList.innerHTML =
            "<p style='text-align:center;opacity:0.5;margin-top:20px'>No history</p>";
        return;
    }

    history.forEach(item => {
        const div = document.createElement("div");
        div.className = "history-item";

        div.innerHTML = `
            <div class="history-top">
                <b class="history-title">${item.title}</b>
            </div>
            <small>Resume at ${formatTime(item.time)} â€¢ ${item.date}</small>

           <i class="ph ph-trash history-remove" title="Remove from history"></i>

        `;

        /* â–¶ Click item = play */
        div.addEventListener("click", () => {
            closePopup(historyOverlay);
            currentVideoURL = item.url;
            loadVideo(item.url);
            video.currentTime = item.time;
            video.play().catch(()=>{});
        });

        /* ðŸ—‘ Remove icon logic */
        div.querySelector(".history-remove").addEventListener("click", (e) => {
            e.stopPropagation(); // âŒ must not play video
            removeHistoryItem(item.url, div);
        });

        historyList.appendChild(div);
    });
}

function updateFullscreenIcon() {
  fullscreenBtn.className =
    "ph ctrl-icon " +
    (document.fullscreenElement ? "ph-arrows-in" : "ph-arrows-out");
}

document.addEventListener("fullscreenchange", updateFullscreenIcon);
document.addEventListener("webkitfullscreenchange", updateFullscreenIcon);
if ('serviceWorker' in navigator) {
    navigator.serviceWorker.register("sw.js");
}
// ==========================================
// MINI PLAYER (Picture-in-Picture)
// ==========================================
const pipBtn = document.getElementById("pipBtn");

async function togglePiP() {
  if (!document.pictureInPictureEnabled || video.disablePictureInPicture) {
    alert("Mini Player not supported in this browser");
    return;
  }

  try {
    if (document.pictureInPictureElement) {
      await document.exitPictureInPicture();
    } else {
      await video.requestPictureInPicture();
    }
  } catch (err) {
    console.error("PiP error:", err);
  }
}

pipBtn.addEventListener("click", (e) => {
  e.stopPropagation();
  togglePiP();
});

// Sync icon state
video.addEventListener("enterpictureinpicture", () => {
  pipBtn.className = "ph ctrl-icon ph-picture-in-picture-slash";
});

video.addEventListener("leavepictureinpicture", () => {
  pipBtn.className = "ph ctrl-icon ph-picture-in-picture";
});
video.addEventListener("enterpictureinpicture", () => {
  controlsContainer.classList.add("hidden");
});

video.addEventListener("leavepictureinpicture", () => {
  resetActivity();
});

function loadVideo(url) {
    if (!navigator.onLine) {
        video.src = url; // served from cache
        return;
    }

    if (Hls.isSupported() && url.endsWith(".m3u8")) {
        if (window.hls) window.hls.destroy();
        const hls = new Hls();
        hls.loadSource(url);
        hls.attachMedia(video);
        window.hls = hls;
    } else {
        video.src = url;
    }
}

</script>

</body>
</html>