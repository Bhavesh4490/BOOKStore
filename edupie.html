<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>EduPie | Your GameChanger</title>
    <!-- Fonts & Icons -->
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <style>
        /* --- VARIABLES & RESET --- */
        :root {
            --bg-dark: #0b1220;
            --bg-panel: rgba(17, 26, 46, 0.7);
            --neon-blue: #00f0ff;
            --neon-pink: #ff00f0;
            --neon-cyan: #0ff;
            --text-main: #ffffff;
            --text-mute: #a0aec0;
            --glass-border: rgba(255, 255, 255, 0.1);
            --glass-highlight: rgba(255, 255, 255, 0.05);
            --font-main: 'Poppins', sans-serif;
        }

        * { margin: 0; padding: 0; box-sizing: border-box; font-family: var(--font-main); }

        body {
            background-color: var(--bg-dark);
            background-image: 
                radial-gradient(circle at 10% 20%, rgba(0, 240, 255, 0.1) 0%, transparent 20%),
                radial-gradient(circle at 90% 80%, rgba(255, 0, 240, 0.1) 0%, transparent 20%);
            color: var(--text-main);
            min-height: 100vh;
            overflow-x: hidden;
            display: flex;
            flex-direction: column;
        }

        /* --- ANIMATIONS --- */
        @keyframes fadeIn { from { opacity: 0; transform: translateY(20px); } to { opacity: 1; transform: translateY(0); } }
        @keyframes pulseGlow { 0% { box-shadow: 0 0 5px var(--neon-blue); } 50% { box-shadow: 0 0 20px var(--neon-blue), 0 0 10px var(--neon-pink); } 100% { box-shadow: 0 0 5px var(--neon-blue); } }
        @keyframes float { 0% { transform: translateY(0px); } 50% { transform: translateY(-5px); } 100% { transform: translateY(0px); } }
        @keyframes glowText { 0% { text-shadow: 0 0 5px #1e90ff; } 50% { text-shadow: 0 0 20px #00c3ff, 0 0 10px #ff00f0; } 100% { text-shadow: 0 0 5px #1e90ff; } }

        /* --- UI COMPONENTS --- */
        /* Glassmorphism Card Utility */
        .glass-panel {
            background: var(--bg-panel);
            backdrop-filter: blur(12px);
            -webkit-backdrop-filter: blur(12px);
            border: 1px solid var(--glass-border);
            box-shadow: 0 8px 32px 0 rgba(0, 0, 0, 0.37);
        }

        button { cursor: pointer; border: none; outline: none; transition: all 0.3s ease; font-weight: 600; letter-spacing: 0.5px; }

        /* Neon Gradient Button */
        .btn-neon {
            background: linear-gradient(135deg, var(--neon-blue), var(--neon-pink));
            color: #fff;
            padding: 12px 30px;
            border-radius: 50px;
            box-shadow: 0 0 15px rgba(0, 240, 255, 0.4);
            position: relative;
            overflow: hidden;
            z-index: 1;
        }
        .btn-neon::before {
            content: ''; position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            background: linear-gradient(135deg, var(--neon-pink), var(--neon-blue));
            opacity: 0; transition: 0.3s; z-index: -1;
        }
        .btn-neon:hover { transform: translateY(-3px); box-shadow: 0 0 30px rgba(255, 0, 240, 0.6); }
        .btn-neon:hover::before { opacity: 1; }

        /* Secondary / Outline Button */
        .btn-secondary {
            background: transparent;
            border: 1px solid var(--neon-blue);
            color: var(--neon-blue);
            padding: 10px 20px;
            border-radius: 8px;
        }
        .btn-secondary:hover { background: rgba(0, 240, 255, 0.1); box-shadow: 0 0 15px rgba(0, 240, 255, 0.3); color: #fff; }
        .btn-secondary:disabled { border-color: #555; color: #555; cursor: not-allowed; box-shadow: none; }

        /* Small Button */
        .btn-small {
            font-size: 0.8rem; padding: 6px 14px; border-radius: 20px;
            border: 1px solid var(--neon-pink); color: var(--neon-pink); background: transparent;
        }
        .btn-small:hover { background: var(--neon-pink); color: white; box-shadow: 0 0 10px var(--neon-pink); }

        /* --- NAVIGATION --- */
        nav {
            display: grid;
            grid-template-columns: 1fr auto 1fr;
            align-items: center;
            padding: 1rem 5%;
            background: rgba(11, 18, 32, 0.85);
            backdrop-filter: blur(15px);
            border-bottom: 1px solid rgba(255,255,255,0.08);
            position: sticky; top: 0; z-index: 1000;
        }
        .logo-placeholder { width: 100%; }
        .logo-wrapper { justify-self: center; animation: float 3s ease-in-out infinite; }
        .logo-text { font-size: 1.8rem; font-weight: 800; background: linear-gradient(90deg, #fff, var(--neon-blue)); -webkit-background-clip: text; -webkit-text-fill-color: transparent; letter-spacing: 1px; }
        
        #auth-section { justify-self: end; display: flex; align-items: center; gap: 15px; }
        #user-info { display: flex; align-items: center; gap: 10px; }
        #user-name { color: var(--neon-blue); font-weight: 600; text-shadow: 0 0 5px rgba(0,240,255,0.5); }

        /* --- LAYOUT CONTAINER --- */
        .container {
            width: 100%; max-width: 1200px; margin: 0 auto; padding: 40px 20px;
            flex: 1;
        }
        
        .view { display: none; animation: fadeIn 0.6s cubic-bezier(0.22, 1, 0.36, 1); }
        .view.active { display: block; }
        .section-title { font-size: 2rem; margin-bottom: 2rem; border-left: 4px solid var(--neon-pink); padding-left: 20px; text-transform: uppercase; letter-spacing: 2px; }

        /* --- DASHBOARD --- */
        .quiz-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 30px; }
        
        .quiz-card {
            background: linear-gradient(145deg, rgba(255,255,255,0.03), rgba(255,255,255,0.01));
            border: 1px solid var(--glass-border);
            border-radius: 20px;
            padding: 25px;
            position: relative;
            transition: 0.4s;
            overflow: hidden;
        }
        .quiz-card::before {
            content: ''; position: absolute; top: 0; left: 0; width: 4px; height: 100%;
            background: var(--neon-blue); transition: 0.3s;
        }
        .quiz-card:hover { transform: translateY(-10px) scale(1.02); border-color: var(--neon-blue); box-shadow: 0 15px 30px rgba(0,0,0,0.5), 0 0 20px rgba(0, 240, 255, 0.1); }
        .quiz-card:hover::before { width: 100%; opacity: 0.1; }
        
        .card-title { font-size: 1.6rem; color: #fff; margin-bottom: 10px; }
        .card-info { color: var(--text-mute); margin-bottom: 25px; font-size: 0.95rem; display: flex; align-items: center; gap: 10px; }
        .card-actions { display: flex; justify-content: space-between; align-items: center; margin-top: auto; }

        /* --- QUIZ INTERFACE --- */
        .quiz-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 30px; background: rgba(0,0,0,0.2); padding: 15px 25px; border-radius: 15px; border: 1px solid var(--glass-border); }
        
        .timer-badge {
            font-size: 1.5rem; font-family: 'Courier New', monospace; font-weight: bold;
            color: var(--neon-pink); text-shadow: 0 0 10px var(--neon-pink);
            display: flex; align-items: center; gap: 10px;
        }

        .progress-bar { height: 8px; background: rgba(255,255,255,0.1); border-radius: 10px; margin-bottom: 30px; overflow: hidden; position: relative; }
        .progress-fill { height: 100%; background: linear-gradient(90deg, var(--neon-blue), var(--neon-pink)); width: 0%; transition: width 0.5s cubic-bezier(0.4, 0, 0.2, 1); box-shadow: 0 0 10px var(--neon-blue); }

        .question-box {
            background: var(--bg-panel); border-radius: 20px; padding: 40px; 
            border: 1px solid rgba(0, 240, 255, 0.3);
            box-shadow: 0 0 30px rgba(0, 0, 0, 0.5);
            position: relative;
        }
        
        .question-img-box { text-align: center; margin-bottom: 20px; border-radius: 15px; overflow: hidden; border: 1px solid var(--glass-border); }
        .question-img-box img { max-width: 100%; max-height: 300px; display: block; margin: 0 auto; }
        
        #question-text { font-size: 1.4rem; font-weight: 600; line-height: 1.6; margin-bottom: 30px; }
        
        .options-grid { display: grid; gap: 15px; }
        .option-btn {
            background: rgba(255,255,255,0.03); color: var(--text-mute); padding: 18px 25px; border-radius: 12px;
            text-align: left; font-size: 1.1rem; border: 1px solid transparent; transition: 0.2s; position: relative;
        }
        .option-btn:hover { background: rgba(255,255,255,0.1); transform: translateX(5px); border-color: rgba(255,255,255,0.3); }
        .option-btn.selected {
            background: rgba(0, 240, 255, 0.15); border-color: var(--neon-blue); color: #fff;
            box-shadow: 0 0 15px rgba(0, 240, 255, 0.2);
        }
        .option-btn.selected::after { content: '‚úî'; position: absolute; right: 20px; color: var(--neon-blue); }

        .quiz-controls { display: flex; justify-content: space-between; align-items: center; margin-top: 30px; }
        .q-counter { color: var(--text-mute); font-size: 1.1rem; }

        /* --- REPORT CARD --- */
        .report-card {
            background: var(--bg-panel); backdrop-filter: blur(20px); border-radius: 30px;
            padding: 50px; text-align: center; max-width: 700px; margin: 20px auto;
            border: 1px solid var(--glass-border); box-shadow: 0 20px 50px rgba(0,0,0,0.6);
            position: relative; overflow: hidden;
        }
        .report-card::before {
            content: ''; position: absolute; top: 0; left: 0; width: 100%; height: 5px;
            background: linear-gradient(90deg, var(--neon-blue), var(--neon-pink), var(--neon-blue));
            animation: gradientMove 3s linear infinite; background-size: 200% 100%;
        }
        @keyframes gradientMove { 0% { background-position: 100% 0; } 100% { background-position: -100% 0; } }

        #res-rank-title { font-size: 2.5rem; color: var(--neon-pink); font-weight: 800; margin: 10px 0; text-transform: uppercase; text-shadow: 0 0 20px rgba(255, 0, 240, 0.4); animation: pulseGlow 2s infinite; }
        
        .score-circle {
            width: 180px; height: 180px; border-radius: 50%;
            background: conic-gradient(var(--neon-blue) 0%, rgba(255,255,255,0.1) 0%);
            display: flex; justify-content: center; align-items: center;
            margin: 30px auto; position: relative;
            box-shadow: 0 0 30px rgba(0, 240, 255, 0.2);
        }
        .score-inner {
            width: 160px; height: 160px; border-radius: 50%; background: var(--bg-dark);
            display: flex; justify-content: center; align-items: center;
            font-size: 3rem; font-weight: bold; color: #fff;
        }

        .stats-grid { display: grid; grid-template-columns: repeat(2, 1fr); gap: 20px; margin-bottom: 30px; }
        @media (min-width: 600px) { .stats-grid { grid-template-columns: repeat(4, 1fr); } }

        .stat-box { background: rgba(255,255,255,0.03); padding: 15px; border-radius: 15px; border: 1px solid var(--glass-border); }
        .stat-box h3 { font-size: 0.8rem; color: var(--text-mute); text-transform: uppercase; margin-bottom: 5px; }
        .stat-box span { font-size: 1.8rem; font-weight: bold; }
        .correct span { color: #00ff88; } .wrong span { color: #ff4444; } .attempted span { color: var(--neon-blue); }

        /* --- LEADERBOARD --- */
        .leaderboard-container { background: var(--bg-panel); padding: 30px; border-radius: 20px; border: 1px solid var(--glass-border); }
        
        .lb-table { width: 100%; border-collapse: separate; border-spacing: 0 10px; }
        .lb-table th { color: var(--text-mute); text-transform: uppercase; font-size: 0.8rem; padding: 15px; text-align: left; border-bottom: 1px solid var(--glass-border); }
        .lb-table td { background: rgba(255,255,255,0.02); padding: 15px; transition: 0.3s; }
        .lb-table tr:hover td { background: rgba(255,255,255,0.08); transform: scale(1.01); }
        .lb-table tr td:first-child { border-top-left-radius: 10px; border-bottom-left-radius: 10px; }
        .lb-table tr td:last-child { border-top-right-radius: 10px; border-bottom-right-radius: 10px; }

        .rank-badge { width: 35px; height: 35px; border-radius: 50%; display: flex; justify-content: center; align-items: center; font-weight: bold; background: #222; margin: 0 auto; }
        /* Rank Colors */
        tr:nth-child(1) .rank-badge { background: linear-gradient(135deg, #ffd700, #ffaa00); color: #000; box-shadow: 0 0 15px #ffd700; }
        tr:nth-child(2) .rank-badge { background: linear-gradient(135deg, #e0e0e0, #b0b0b0); color: #000; box-shadow: 0 0 15px #c0c0c0; }
        tr:nth-child(3) .rank-badge { background: linear-gradient(135deg, #cd7f32, #a05a2c); color: #000; box-shadow: 0 0 15px #cd7f32; }

        .player-info { display: flex; flex-direction: column; }
        .player-name { font-weight: 700; font-size: 1.1rem; color: #fff; }
        .player-rank-title { font-size: 0.8rem; color: var(--neon-pink); text-transform: uppercase; letter-spacing: 1px; }

       /* --- 5. SOCIAL & FOOTER (From Oswaal) --- */
.social-buttons {
display: flex;
justify-content: center;
gap: 15px;
margin: 20px 0 40px;
}

.social-btn {
display: flex;
align-items: center;
gap: 10px;
padding: 12px 24px;
border-radius: 40px;
background: rgba(0,0,0,0.3);
color: white;
text-decoration: none;
font-weight: 500;
transition: 0.3s;
border: 1px solid transparent;
font-family: var(--font-body);
font-size: 0.95rem;
}

.social-btn:hover {
background: #27272a;
border-color: rgba(255,255,255,0.1);
transform: translateY(-2px);
}

.social-btn.insta:hover { color: #e1306c; border-color: #e1306c; }
.social-btn.telegram:hover { color: #0088cc; border-color: #0088cc; }

.social-logo {
width: 22px;
height: 22px;
object-fit: contain;
}

        footer { text-align: center; padding: 30px; background: rgba(0,0,0,0.3); margin-top: auto; border-top: 1px solid var(--glass-border); }
        .madeby { font-size: 1.2rem; font-weight: bold; animation: glowText 3s infinite linear; margin-bottom: 10px; display: inline-block; }
        .footer-links a { color: var(--text-mute); margin: 0 10px; text-decoration: none; font-size: 0.9rem; transition: 0.3s; }
        .footer-links a:hover { color: var(--neon-blue); }

        /* --- TOAST --- */
        #toast {
            visibility: hidden; min-width: 300px;
            background: rgba(11, 18, 32, 0.95); color: #fff; border-left: 5px solid var(--neon-pink);
            text-align: center; border-radius: 5px; padding: 16px; position: fixed; z-index: 2000;
            bottom: 30px; left: 50%; transform: translateX(-50%);
            box-shadow: 0 5px 20px rgba(0,0,0,0.5); backdrop-filter: blur(5px);
        }
        #toast.show { visibility: visible; animation: fadein 0.5s, fadeout 0.5s 2.5s; }
        @keyframes fadein { from {bottom: 0; opacity: 0;} to {bottom: 30px; opacity: 1;} }
        @keyframes fadeout { from {bottom: 30px; opacity: 1;} to {bottom: 0; opacity: 0;} }
        
        /* Utility */
        .hidden { display: none !important; }
        @media (max-width: 768px) {
            nav { padding: 1rem; grid-template-columns: auto 1fr auto; gap: 10px; }
            .logo-text { font-size: 1.2rem; }
            .section-title { font-size: 1.5rem; }
            .quiz-header { flex-direction: column; gap: 15px; align-items: flex-start; }
            .timer-badge { align-self: flex-end; }
        }
        .social-btn.youtube:hover {
  color: #ff0000;
  border-color: #ff0000;
  box-shadow: 0 0 14px rgba(255, 0, 0, 0.35);
}
    </style>
</head>
<body>

    <!-- NAV -->
    <nav>
        <div class="logo-placeholder"></div>
        <div class="logo-wrapper">
    <img 
        src="edupie.png" 
        alt="Edupie Logo"
        style="
            height: 48px;
            animation: float 3s ease-in-out infinite;
            filter: drop-shadow(0 0 10px rgba(0,240,255,0.4));
        "
    >
</div>

        <div id="auth-section">
            <button id="login-btn" class="btn-neon">
                <i class="fab fa-google"></i> Login
            </button>
            <div id="user-info" class="hidden">
                <span id="user-name">User</span>
                <button id="logout-btn" class="btn-small">Logout</button>
            </div>
        </div>
    </nav>

    <!-- CONTENT -->
    <div class="container">
        
        <!-- DASHBOARD -->
        <div id="dashboard-view" class="view active">
            <h1 class="section-title">Battle Arena <span style="font-size:0.5em; vertical-align:middle; color:var(--text-mute)">Select a Subject</span></h1>
            <div class="quiz-grid" id="quiz-container">
                <!-- Cards injected via JS -->
            </div>
        </div>

        <!-- QUIZ INTERFACE -->
        <div id="quiz-view" class="view hidden">
            <div class="quiz-header">
                <h2 id="quiz-title-display" style="color:var(--neon-cyan)">Subject Name</h2>
                <div class="timer-badge">
                    <i class="fas fa-stopwatch"></i> <span id="timer">00:00</span>
                </div>
            </div>
            
            <div class="progress-bar">
                <div class="progress-fill" id="progress-fill"></div>
            </div>

            <div class="question-box">
                <div id="question-img-box" class="question-img-box hidden">
                    <img id="question-img" src="" alt="Question Image">
                </div>

                <h3 id="question-text">Question Loading...</h3>
                <div class="options-grid" id="options-container"></div>
                
                <div class="quiz-controls">
                    <button id="prev-btn" class="btn-secondary" disabled><i class="fas fa-chevron-left"></i> Prev</button>
                    <p class="q-counter">LEVEL <span id="q-current" style="color:#fff; font-weight:bold;">1</span> / <span id="q-total">5</span></p>
                    <button id="next-btn" class="btn-neon" disabled>Next <i class="fas fa-chevron-right"></i></button>
                </div>
            </div>
        </div>

        <!-- RESULTS -->
        <div id="result-view" class="view hidden">
            <div class="report-card">
                <h2>Mission Complete</h2>
                <p id="res-rank-title">Rank Name</p>

                <div class="score-circle" id="score-circle-border">
                    <div class="score-inner">
                        <span id="score-percentage">0%</span>
                    </div>
                </div>
                
                <div class="stats-grid">
                    <div class="stat-box correct">
                        <h3>Correct</h3> <span id="res-correct">0</span>
                    </div>
                    <div class="stat-box wrong">
                        <h3>Wrong</h3> <span id="res-wrong">0</span>
                    </div>
                    <div class="stat-box attempted">
                        <h3>Total XP</h3> <span id="res-attempted">0</span>
                    </div>
                    <div class="stat-box">
                        <h3>Time</h3> <span id="res-time" style="color:var(--text-main)">0s</span>
                    </div>
                </div>

                <div style="display:flex; gap:15px; justify-content:center; flex-wrap:wrap;">
                    <button id="view-lb-from-res" class="btn-secondary">View Leaderboard</button>
                    <button id="back-home-btn" class="btn-neon">Back to Arena</button>
                </div>
            </div>
        </div>
        
        <!-- LEADERBOARD -->
        <div id="leaderboard-view" class="view hidden">
            <div class="leaderboard-container">
                <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:20px;">
                    <h2 class="section-title" style="margin:0;">üèÜ Hall of Fame</h2>
                    <button id="lb-back-btn" class="btn-small">Close</button>
                </div>
                <h3 style="color:var(--neon-blue); margin-bottom:20px;" id="lb-quiz-title">General Quiz</h3>
                
                <div style="overflow-x: auto;">
                    <table class="lb-table">
                        <thead>
                            <tr>
                                <th width="10%">Rank</th>
                                <th>Player</th>
                                <th>Score</th>
                                <th>Time</th>
                            </tr>
                        </thead>
                        <tbody id="lb-body">
                        </tbody>
                    </table>
                </div>
            </div>
        </div>

    </div>

     <!-- SOCIAL LINKS -->
 <div class="social-buttons">
    <a href="https://www.youtube.com/@bookstoreofficial"
     target="_blank"
     class="social-btn youtube"
     title="Subscribe on YouTube"
     aria-label="Subscribe on YouTube">
    <img src="https://cdn-icons-png.flaticon.com/512/1384/1384060.png"
         alt="YouTube"
         class="social-logo">
    YouTube
  </a>
<a href="https://www.instagram.com/bookstoreofficial_0/" target="_blank" class="social-btn insta">
<img src="https://cdn-icons-png.flaticon.com/512/2111/2111463.png" alt="Instagram" class="social-logo">
Instagram
</a>
<a href="https://t.me/+oQOMU7yAIIE2OWVl" target="_blank" class="social-btn telegram">
<img src="https://cdn-icons-png.flaticon.com/512/2111/2111646.png" alt="Telegram" class="social-logo">
Telegram
</a>
</div>


    <footer>
        <div class="madeby">Made by Bhavesh</div>
        <div class="footer-links">
            <p style="color:#666; font-size:0.8rem;">¬© 2025 EduPie. All rights reserved.</p>
        </div>
    </footer>

    <div id="toast">Alert Message</div>

    <!-- JAVASCRIPT MODULE -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/9.22.0/firebase-app.js";
        import { getAuth, GoogleAuthProvider, signInWithPopup, signOut, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/9.22.0/firebase-auth.js";
        import { getDatabase, ref, get, child, update, onValue } from "https://www.gstatic.com/firebasejs/9.22.0/firebase-database.js";

        // CONFIG
        const firebaseConfig = {
            apiKey: "AIzaSyCcpG-oEqkDprgTwWXKt5CFsttjAQAZFNg",
            authDomain: "bookstore-6ab08.firebaseapp.com",
            databaseURL: "https://bookstore-6ab08-default-rtdb.firebaseio.com",
            projectId: "bookstore-6ab08",
            storageBucket: "bookstore-6ab08.firebasestorage.app",
            messagingSenderId: "102226032749",
            appId: "1:102226032749:web:f7090175d2e53c2f522764"
        };

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getDatabase(app);
        const provider = new GoogleAuthProvider();

        // DATA
        const quizzes = [
            {
                id: "electricity_01",
                title: "Electricity",
                subject: "Physics ‚Ä¢ Class 10",
                icon: "fa-bolt",
                questions: [
                    { q: "Calculate the current flows through the 10 Œ© resistor in the following circuit.", options: ["(a) 1.2 A", "(b) 0.6 A", "(c) 0.2 A", "(d) 2.0 A"], ans: 1 },
                    { q: "The least resistance obtained by using 2 Œ©, 4 Œ©, 1 Œ© and 100 Œ© is", options: ["(a) < 100 Œ©", "(b) < 4 Œ©", "(c) < 1 Œ©", "(d) > 2 Œ©"], ans: 2 },
                    { q: "A wire of length l, made of material resistivity œÅ is cut into two equal parts. the resistivity of the two parts are equal to,", options: ["(a) œÅ", "(b) œÅ/2", "(c) 2œÅ", "(d) 4œÅ"], ans: 0 },
                    { q: "The effective resistance between A and B is", options: ["(a) 4 Œ©", "(b) 6 Œ©", "(c) May be 10 Œ©", "(d) Must be 10 Œ©"], ans: 0 },
                    { q: "A student carries out an experiment and plots the V-I graphs of three samples of nichrome wire with resistances R1, R2 and R3 respectively. Which of the following is true ?", options: ["(a) R1 = R2 = R3", "(b) R1 > R2 > R3", "(c) R3 > R2 > R1", "(d) R2 > R3 > R1"], ans: 2 }
                ]
            },
            {
                id: "science_01",
                title: "General Science",
                subject: "Mixed ‚Ä¢ Class 10",
                icon: "fa-flask",
                questions: [
                    { q: "You are given water, mustard oil, glycerine, and kerosene. In which of these media will a ray of light incident obliquely at the same angle bend the most?", options: ["(a) Kerosene", "(b) Water", "(c) Mustard oil", "(d) Glycerine"], ans: 3 },
                    { q: "The direction of the force on a current-carrying conductor in a magnetic field is given by:", options: ["(a) Fleming‚Äôs Left-Hand Rule", "(b) Fleming‚Äôs Right-Hand Rule", "(c) Right-Hand Thumb Rule", "(d) Left-Hand Thumb Rule"], ans: 0 },
                    { q: "A cylindrical conductor of length l and uniform area of cross-section A has resistance R. Another conductor of length 2l and resistance R of the same material has an area of cross-section:", options: ["(a) A/2", "(b) 3A/2", "(c) 2A", "(d) 3A"], ans: 2 },
                    { q: "Electrolysis of water is a decomposition reaction. The mole ratio of hydrogen and oxygen gases liberated during electrolysis of water is:", options: ["(a) 1:1", "(b) 2:1", "(c) 4:1", "(d) 1:2"], ans: 1 },
                    { q: "Which of the following correct represents the reaction involved when electricity is passed through water?", options: ["(a) Displacement", "(b) Combination", "(c) Decomposition", "(d) Double Displacement"], ans: 2 }
                ]
            },
            {
                id: "math_01",
                title: "Mathematics",
                subject: "Class 10",
                icon: "fa-calculator",
                questions: [
                    { q: "The HCF of two consecutive even numbers is always:", options: ["(a) 1", "(b) 2", "(c) 4", "(d) Prime"], ans: 1 },
                    { q: "The pair of linear equations 2x = 5y + 6 and 15y = 6x - 18 represents two lines which are: ", options: ["(a) intersecting", "(b) parallel", "(c) coincident", "(d) intersecting/parallel"], ans: 2 },
                    { q: "The distance of the point (4, 7) from the x-axis is:", options: ["(a) 7 units", "(b) 5 units", "(c) 4 units", "(d) 10 units"], ans: 0 },
                    { q: "The next term of the A.P.: ‚àö7, ‚àö28, ‚àö63 is", options: ["(a) ‚àö70", "(b) ‚àö80", "(c) ‚àö97", "(d) ‚àö112"], ans: 3 },
                    { q: "If a bicycle wheel makes 5000 revolutions in moving 11 km, then the diameter of the wheel is:", options: ["(a)65 cm", "(b)35 cm", "(c) 70 cm", "(d) 50 cm"], ans: 2 }
                ]
            },
            {
                id: "sst_01",
                title: "Social Studies",
                subject: "History & Civics",
                icon: "fa-globe-asia",
                questions: [
                    { q: "The immediate cause for calling off the Non-Cooperation Movement by Gandhiji was:", options: ["(a) Gandhi-Irwin Pact", "(b) British pressure", "(c) Chauri Chaura Incident", "(d) Failure of Swaraj"], ans: 2 },
                    { q: "The form of power sharing adopted by the Belgian model is best described as:", options: ["(a) Vertical division", "(b) Holding together", "(c) Coming together", "(d) Coalition"], ans: 1 },
                    { q: "Which of the following is an example of an Intermediate Good?", options: ["(a) School bus", "(b) Flour for baker", "(c) Tractor for farmer", "(d) New car"], ans: 1 },
                    { q: "Which resource is formed due to the decomposition of rocks, leaving a residual mass of weathered material?", options: ["(a) Mica", "(b) Iron Ore", "(c) Copper", "(d) Bauxite"], ans: 3 },
                ]
            }
        ];

        const rankTiers = [
            { title: "Bronze", minScore: 0, maxScore: 1, icon: "ü•ö" },
            { title: "Gold", minScore: 2, maxScore: 3, icon: "ü•â" },
            { title: "Diamond", minScore: 4, maxScore: 4, icon: "ü•à" },
            { title: "GrandMaster", minScore: 5, maxScore: 5, icon: "ü•á" } 
        ];

        // HELPERS
        function getRankTitle(score, totalQuestions) {
            const tiers = rankTiers.map(tier => ({ ...tier, maxScore: Math.min(tier.maxScore, totalQuestions)}));
            const rank = tiers.find(t => score >= t.minScore && score <= t.maxScore);
            return rank ? `${rank.icon} ${rank.title}` : "Challenger";
        }
        function encodeEmailToKey(email) {
            if (!email) return 'anonymous_user';
            return email.replace(/\./g, '_dot_').replace(/#/g, '_hash_').replace(/\$/g, '_dollar_').replace(/\[/g, '_openbracket_').replace(/\]/g, '_closebracket_').replace(/@/g, '_at_');
        }
        function decodeKeyToEmail(key) {
            if (!key) return 'N/A';
            return key.replace(/_dot_/g, '.').replace(/_hash_/g, '#').replace(/_dollar_/g, '$').replace(/_openbracket_/g, '[').replace(/_closebracket_/g, ']').replace(/_at_/g, '@');
        }
        function formatSeconds(seconds) {
            if (typeof seconds !== 'number' || isNaN(seconds) || seconds < 0) return 'N/A';
            const m = Math.floor(seconds / 60).toString().padStart(2, '0');
            const s = (seconds % 60).toString().padStart(2, '0');
            return `${m}:${s}`;
        }

        // STATE & DOM
        let currentUser = null;
        let currentQuiz = null;
        let currentQuestionIndex = 0;
        let userAnswers = {}; 
        let timerInterval;
        let startTime, endTime;
        let unsubscribeLeaderboard = null;

        const views = {
            dashboard: document.getElementById('dashboard-view'),
            quiz: document.getElementById('quiz-view'),
            result: document.getElementById('result-view'),
            leaderboard: document.getElementById('leaderboard-view') 
        };

        const els = {
            loginBtn: document.getElementById('login-btn'),
            userInfo: document.getElementById('user-info'),
            userName: document.getElementById('user-name'),
            logoutBtn: document.getElementById('logout-btn'),
            quizContainer: document.getElementById('quiz-container'),
            quizTitle: document.getElementById('quiz-title-display'),
            timer: document.getElementById('timer'),
            progressBar: document.getElementById('progress-fill'),
            questionText: document.getElementById('question-text'),
            optionsContainer: document.getElementById('options-container'),
            prevBtn: document.getElementById('prev-btn'),
            nextBtn: document.getElementById('next-btn'),
            qCurrent: document.getElementById('q-current'),
            qTotal: document.getElementById('q-total'),
            // Result
            scorePercent: document.getElementById('score-percentage'),
            resRankTitle: document.getElementById('res-rank-title'), 
            resCorrect: document.getElementById('res-correct'),
            resWrong: document.getElementById('res-wrong'),
            resAttempted: document.getElementById('res-attempted'),
            resTime: document.getElementById('res-time'),
            backHomeBtn: document.getElementById('back-home-btn')
        };

        // AUTH
        els.loginBtn.addEventListener('click', () => signInWithPopup(auth, provider));
        els.logoutBtn.addEventListener('click', () => signOut(auth).then(() => { switchView('dashboard'); showToast("Logged out"); }));
        
        onAuthStateChanged(auth, (user) => {
            currentUser = user;
            if (user) {
                els.loginBtn.classList.add('hidden');
                els.userInfo.classList.remove('hidden');
                els.userName.textContent = user.displayName ? user.displayName.split(' ')[0] : 'Gamer';
                loadDashboard();
            } else {
                els.loginBtn.classList.remove('hidden');
                els.userInfo.classList.add('hidden');
                loadDashboard(); 
            }
        });

        function switchView(viewName) {
            Object.values(views).forEach(v => v.classList.remove('active', 'hidden'));
            Object.values(views).forEach(v => v.classList.add('hidden'));
            views[viewName].classList.remove('hidden');
            views[viewName].classList.add('active');
            window.scrollTo(0,0);
        }

        function showToast(msg) {
            const toast = document.getElementById("toast");
            toast.textContent = msg;
            toast.className = "show";
            setTimeout(() => { toast.className = toast.className.replace("show", ""); }, 3000);
        }

        // DASHBOARD
        async function loadDashboard() {
            els.quizContainer.innerHTML = '<p style="color:var(--text-mute)">Connecting to server...</p>';
            let userResults = {};
            if (currentUser && currentUser.email) {
                try {
                    const snapshot = await get(child(ref(db), `results/${encodeEmailToKey(currentUser.email)}`));
                    if (snapshot.exists()) userResults = snapshot.val();
                } catch (error) { console.error(error); }
            }

            els.quizContainer.innerHTML = '';
            quizzes.forEach(quiz => {
                const hasTaken = userResults[quiz.id] ? true : false;
                const icon = quiz.icon || 'fa-gamepad';
                const card = document.createElement('div');
                card.className = 'quiz-card';
                card.innerHTML = `
                    <div style="display:flex; justify-content:space-between;">
                        <i class="fas ${icon}" style="font-size:2rem; color:var(--neon-blue); margin-bottom:15px;"></i>
                        ${hasTaken ? '<span style="color:#00ff88; font-size:0.8rem;">Completed <i class="fas fa-check-circle"></i></span>' : ''}
                    </div>
                    <h2 class="card-title">${quiz.title}</h2>
                    <p class="card-info">${quiz.subject} ‚Ä¢ ${quiz.questions.length} Qs</p>
                    <div class="card-actions">
                        <button class="btn-neon action-btn" data-id="${quiz.id}" data-taken="${hasTaken}">
                            ${hasTaken ? 'View Result' : 'Start Battle'}
                        </button>
                        
                    </div>
                `;
                els.quizContainer.appendChild(card);
            });

            document.querySelectorAll('.action-btn').forEach(btn => {
                btn.addEventListener('click', (e) => {
                    const quizId = e.target.closest('button').dataset.id;
                    const taken = e.target.closest('button').dataset.taken === 'true';
                    if (!currentUser) { showToast("Login required to play!"); return; }
                    taken ? fetchAndShowResult(quizId) : startQuiz(quizzes.find(q => q.id === quizId));
                });
            });

            document.querySelectorAll('.lb-btn').forEach(btn => {
                btn.addEventListener('click', (e) => loadLeaderboard(e.target.closest('button').dataset.id));
            });
        }

        // QUIZ ENGINE
        function startQuiz(quiz) {
            currentQuiz = quiz;
            currentQuestionIndex = 0;
            userAnswers = {};
            startTime = new Date();
            els.quizTitle.textContent = quiz.title;
            els.qTotal.textContent = quiz.questions.length;
            startTimer();
            switchView('quiz');
            renderQuestion();
        }

        function startTimer() {
            let seconds = 0;
            clearInterval(timerInterval);
            els.timer.textContent = "00:00";
            timerInterval = setInterval(() => {
                seconds++;
                els.timer.textContent = formatSeconds(seconds);
            }, 1000);
        }

        function renderQuestion() {
            const qData = currentQuiz.questions[currentQuestionIndex];
            els.questionText.textContent = `${currentQuestionIndex + 1}. ${qData.q}`;
            els.qCurrent.textContent = currentQuestionIndex + 1;
            els.progressBar.style.width = `${((currentQuestionIndex) / currentQuiz.questions.length) * 100}%`;

            els.optionsContainer.innerHTML = '';
            qData.options.forEach((opt, index) => {
                const btn = document.createElement('button');
                btn.className = 'option-btn';
                btn.textContent = opt;
                if (userAnswers[currentQuestionIndex] === index) btn.classList.add('selected');
                btn.addEventListener('click', () => selectOption(index));
                els.optionsContainer.appendChild(btn);
            });

            // Images logic
            const imgBox = document.getElementById('question-img-box');
            const imgEl = document.getElementById('question-img');
            if (currentQuiz.id === "electricity_01") {
                if (currentQuestionIndex === 0) {
                    imgEl.src = "https://hi-static.z-dn.net/files/df4/ddbf79a5e9465403f35c4d17ffa04ba9.jpg";
                    imgBox.classList.remove('hidden');
                } else if (currentQuestionIndex === 3) {
                    imgEl.src = "https://encrypted-tbn0.gstatic.com/images?q=tbn:ANd9GcTu_idWQOdzi4EwUghp49StygI6kMjoLrqrJaXbG5dN-v2DJD_7PxYKBnp_O3JGXVdy3gs&usqp=CAU";
                    imgBox.classList.remove('hidden');
                } else if (currentQuestionIndex === 4) {
                    imgEl.src = "data:image/png;base64,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";
                    imgBox.classList.remove('hidden');
                } else { imgBox.classList.add('hidden'); }
            } else { imgBox.classList.add('hidden'); }

            els.prevBtn.disabled = currentQuestionIndex === 0;
            els.nextBtn.textContent = (currentQuestionIndex === currentQuiz.questions.length - 1) ? "Submit" : "Next";
            els.nextBtn.innerHTML = (currentQuestionIndex === currentQuiz.questions.length - 1) ? 'Submit <i class="fas fa-flag-checkered"></i>' : 'Next <i class="fas fa-chevron-right"></i>';
            els.nextBtn.disabled = userAnswers[currentQuestionIndex] === undefined;
        }

        function selectOption(index) {
            userAnswers[currentQuestionIndex] = index;
            const buttons = els.optionsContainer.children;
            for (let btn of buttons) btn.classList.remove('selected');
            buttons[index].classList.add('selected');
            els.nextBtn.disabled = false;
        }

        els.prevBtn.addEventListener('click', () => { if(currentQuestionIndex>0){currentQuestionIndex--; renderQuestion();} });
        els.nextBtn.addEventListener('click', () => { if(currentQuestionIndex<currentQuiz.questions.length-1){currentQuestionIndex++; renderQuestion();} else {submitQuiz();} });

        // SUBMIT
        async function submitQuiz() {
            clearInterval(timerInterval);
            const timeTakenSec = Math.floor((new Date() - startTime)/1000);
            const timeDisplay = els.timer.textContent;
            
            let correct = 0, attempted = 0;
            currentQuiz.questions.forEach((q, i) => {
                if(userAnswers[i]!==undefined) { attempted++; if(userAnswers[i]===q.ans) correct++; }
            });
            const wrong = attempted - correct;
            const unattempted = currentQuiz.questions.length - attempted;
            const scorePercent = Math.round((correct/currentQuiz.questions.length)*100);
            const rankTitle = getRankTitle(correct, currentQuiz.questions.length);

            const emailKey = encodeEmailToKey(currentUser.email);
            const resultData = {
                quizName: currentQuiz.title,
                userEmail: currentUser.email,
                stats: { attempted, correct, wrong, unattempted, total: currentQuiz.questions.length, scorePercent, rankTitle },
                timeTaken: timeDisplay,
                timestamp: Date.now()
            };
            const lbEntry = {
                name: currentUser.displayName || 'Anonymous',
                score: correct,
                totalQuestions: currentQuiz.questions.length,
                timeSeconds: timeTakenSec,
                timeString: timeDisplay,
                rankTitle: rankTitle,
                timestamp: Date.now()
            };

            try {
                const updates = {};
                updates[`results/${emailKey}/${currentQuiz.id}`] = resultData;
                updates[`leaderboardquiz/${currentQuiz.id}/${emailKey}`] = lbEntry;
                await update(ref(db), updates);
                renderReportCard(resultData, currentQuiz.id);
            } catch (err) { console.error(err); showToast("Submit failed"); }
        }

        // RESULTS
        async function fetchAndShowResult(quizId) {
            try {
                const snapshot = await get(child(ref(db), `results/${encodeEmailToKey(currentUser.email)}/${quizId}`));
                if (snapshot.exists()) renderReportCard(snapshot.val(), quizId);
                else showToast("No result found");
            } catch(e) { console.error(e); }
        }

        function renderReportCard(data, quizId) {
            const { correct, wrong, attempted, scorePercent, rankTitle } = data.stats;
            els.scorePercent.textContent = `${scorePercent}%`;
            els.resRankTitle.textContent = rankTitle;
            els.resCorrect.textContent = correct;
            els.resWrong.textContent = wrong;
            els.resAttempted.textContent = attempted;
            els.resTime.textContent = data.timeTaken;
            
            // Set circle color based on score
            const borderEl = document.getElementById('score-circle-border');
            borderEl.style.background = `conic-gradient(${scorePercent > 50 ? 'var(--neon-blue)' : 'var(--neon-pink)'} ${scorePercent}%, rgba(255,255,255,0.1) ${scorePercent}%)`;

            switchView('result');
            
            const lbBtn = document.getElementById('view-lb-from-res');
            const newBtn = lbBtn.cloneNode(true);
            lbBtn.parentNode.replaceChild(newBtn, lbBtn);
            newBtn.addEventListener('click', () => loadLeaderboard(quizId || currentQuiz.id));
        }

        els.backHomeBtn.addEventListener('click', () => { loadDashboard(); switchView('dashboard'); });

        // LEADERBOARD
        function loadLeaderboard(quizId) {
            if (unsubscribeLeaderboard) unsubscribeLeaderboard();
            const quiz = quizzes.find(q => q.id === quizId);
            document.getElementById('lb-quiz-title').textContent = quiz ? quiz.title : 'Quiz';
            const lbBody = document.getElementById('lb-body');
            lbBody.innerHTML = '<tr><td colspan="4" style="text-align:center">Loading data...</td></tr>';
            switchView('leaderboard');

            unsubscribeLeaderboard = onValue(ref(db, `leaderboardquiz/${quizId}`), (snap) => {
                if (snap.exists()) {
                    let entries = Object.entries(snap.val()).map(([k, v]) => ({...v, email: decodeKeyToEmail(k)}));
                    entries.sort((a,b) => (b.score - a.score) || ((a.timeSeconds||999) - (b.timeSeconds||999)));
                    
                    lbBody.innerHTML = '';
                    entries.slice(0, 10).forEach((entry, i) => {
                        const tr = document.createElement('tr');
                        tr.innerHTML = `
                            <td><div class="rank-badge">${i+1}</div></td>
                            <td>
                                <div class="player-info">
                                    <span class="player-name">${entry.name}</span>
                                    <span class="player-rank-title">${entry.rankTitle || ''}</span>
                                </div>
                            </td>
                            <td style="font-weight:bold; color:var(--neon-blue);">${entry.score}</td>
                            <td>${entry.timeString}</td>
                        `;
                        lbBody.appendChild(tr);
                    });
                } else { lbBody.innerHTML = '<tr><td colspan="4" style="text-align:center">Be the first to play!</td></tr>'; }
            });
        }
        document.getElementById('lb-back-btn').addEventListener('click', () => { if(unsubscribeLeaderboard) unsubscribeLeaderboard(); loadDashboard(); switchView('dashboard'); });

        // MISC
        window.addEventListener('beforeunload', (e) => { if(currentQuiz) { e.preventDefault(); e.returnValue = ''; } });
    </script>
</body>
</html>